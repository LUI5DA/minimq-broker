<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>System Metrics Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- âœ… Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- âœ… Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            background-color: #f9fafb;
        }
        .navbar {
            background-color: #0d6efd;
        }
        .navbar-brand {
            color: #fff !important;
        }
        .card {
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .chart-container {
            position: relative;
            height: 350px;
        }
    </style>
</head>

<body>
    <!-- ðŸŒ Navbar -->
    <nav class="navbar mb-4">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">ðŸ§­ System Metrics Dashboard</span>
        </div>
    </nav>

    <div class="container">
        <!-- Tabs for metrics -->
        <ul class="nav nav-tabs mb-4" id="topicTabs">
            {% for t in topics %}
            <li class="nav-item">
                <a class="nav-link {% if loop.first %}active{% endif %}" href="#" data-topic="{{ t }}">{{ t|capitalize }}</a>
            </li>
            {% endfor %}
        </ul>

        <!-- Card with Chart -->
        <div class="card p-4">
            <h5 id="chartTitle">CPU Usage</h5>
            <div class="chart-container">
                <canvas id="metricChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        const topics = {{ topics|tojson }};
        let currentTopic = topics[0];
        let chart;
        const chartData = {
            labels: [],
            datasets: [{
                label: '',
                data: [],
                borderColor: '#0d6efd',
                backgroundColor: 'rgba(13,110,253,0.1)',
                fill: true,
                tension: 0.3,
            }]
        };

        // Initialize Chart.js
        function initChart() {
            const ctx = document.getElementById('metricChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: chartData,
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        // Fetch metric from Flask endpoint
        async function fetchMetric() {
            const res = await fetch(`/metrics/${currentTopic}`);
            if (!res.ok) return;
            const data = await res.json();
            if (data.value !== null) {
                const now = new Date().toLocaleTimeString();
                chart.data.labels.push(now);
                chart.data.datasets[0].data.push(data.value);

                // Keep last 10 points
                if (chart.data.labels.length > 10) {
                    chart.data.labels.shift();
                    chart.data.datasets[0].data.shift();
                }

                chart.update();
            }
        }

        // Switch between topics
        document.querySelectorAll('#topicTabs a').forEach(tab => {
            tab.addEventListener('click', (e) => {
                e.preventDefault();
                document.querySelectorAll('#topicTabs a').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentTopic = tab.dataset.topic;
                document.getElementById('chartTitle').innerText = `${currentTopic.toUpperCase()} Usage`;
                chart.data.labels = [];
                chart.data.datasets[0].data = [];
                chart.update();
            });
        });

        // Start chart + interval
        initChart();
        setInterval(fetchMetric, 3000);
    </script>
</body>
</html>
